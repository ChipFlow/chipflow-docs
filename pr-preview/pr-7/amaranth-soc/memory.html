

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Memory maps &mdash; ChipFlow alpha documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../_static/platformpicker.css" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css" />

  
    <link rel="shortcut icon" href="../_static/favicon.png"/>
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=1f169f65"></script>
      <script src="../_static/doctools.js?v=9a2dae69"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../_static/copybutton.js?v=f281be69"></script>
      <script src="../_static/platformpicker.js"></script>
      <script src="../_static/js/init.js?v=dbf28173"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Wishbone" href="wishbone.html" />
    <link rel="prev" title="Amaranth System on Chip toolkit" href="../amaranth-soc.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            ChipFlow
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../amaranth.html">Amaranth Language and Toolchain</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../amaranth-soc.html">Amaranth System on Chip toolkit</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Memory maps</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#resources">Resources</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#adding-resources">Adding resources</a></li>
<li class="toctree-l4"><a class="reference internal" href="#accessing-resources">Accessing resources</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#alignment">Alignment</a></li>
<li class="toctree-l3"><a class="reference internal" href="#windows">Windows</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#adding-windows">Adding windows</a></li>
<li class="toctree-l4"><a class="reference internal" href="#address-translation">Address translation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#freezing">Freezing</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#amaranth_soc.memory.MemoryMap"><code class="docutils literal notranslate"><span class="pre">MemoryMap</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#amaranth_soc.memory.ResourceInfo"><code class="docutils literal notranslate"><span class="pre">ResourceInfo</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="wishbone.html">Wishbone</a></li>
<li class="toctree-l2"><a class="reference internal" href="csr.html">CSR</a></li>
<li class="toctree-l2"><a class="reference internal" href="gpio.html">GPIO</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../chipflow-lib/index.html">ChipFlow Library Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial-intro-chipflow-platform.html">Introduction to the ChipFlow platform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../support.html">Support</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">ChipFlow</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../amaranth-soc.html">Amaranth System on Chip toolkit</a></li>
      <li class="breadcrumb-item active">Memory maps</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/amaranth-soc/memory.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="module-amaranth_soc.memory">
<span id="memory-maps"></span><h1>Memory maps<a class="headerlink" href="#module-amaranth_soc.memory" title="Link to this heading"></a></h1>
<p>The <a class="reference internal" href="#module-amaranth_soc.memory" title="amaranth_soc.memory"><code class="xref py py-mod docutils literal notranslate"><span class="pre">amaranth_soc.memory</span></code></a> module provides primitives for organizing the address space of a bus interface.</p>
<section id="introduction">
<span id="memory-introduction"></span><h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading"></a></h2>
<p>The purpose of <a class="reference internal" href="#amaranth_soc.memory.MemoryMap" title="amaranth_soc.memory.MemoryMap"><code class="xref py py-class docutils literal notranslate"><span class="pre">MemoryMap</span></code></a> is to provide a hierarchical description of the address space of a System-on-Chip, from its bus interconnect to the registers of its peripherals. It is composed of <a class="reference internal" href="#memory-resources"><span class="std std-ref">resources</span></a> (representing registers, memories, etc) and <a class="reference internal" href="#memory-windows"><span class="std std-ref">windows</span></a> (representing bus bridges), and may be <a class="reference internal" href="#memory-accessing-windows"><span class="std std-ref">queried</span></a> afterwards in order to enumerate its contents, or determine the address of a resource.</p>
</section>
<section id="resources">
<span id="memory-resources"></span><h2>Resources<a class="headerlink" href="#resources" title="Link to this heading"></a></h2>
<p>A <em>resource</em> is a <a class="reference internal" href="../amaranth/stdlib/wiring.html#amaranth.lib.wiring.Component" title="amaranth.lib.wiring.Component"><code class="xref py py-class docutils literal notranslate"><span class="pre">Component</span></code></a> previously added to a <a class="reference internal" href="#amaranth_soc.memory.MemoryMap" title="amaranth_soc.memory.MemoryMap"><code class="xref py py-class docutils literal notranslate"><span class="pre">MemoryMap</span></code></a>. Each resource occupies an unique range of addresses within the memory map, and represents a device that is a target for bus transactions.</p>
<section id="adding-resources">
<h3>Adding resources<a class="headerlink" href="#adding-resources" title="Link to this heading"></a></h3>
<p>Resources are added with <a class="reference internal" href="#amaranth_soc.memory.MemoryMap.add_resource" title="amaranth_soc.memory.MemoryMap.add_resource"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MemoryMap.add_resource()</span></code></a>, which returns a <code class="docutils literal notranslate"><span class="pre">(start,</span> <span class="pre">end)</span></code> tuple describing their address range:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">memory_map</span> <span class="o">=</span> <span class="n">MemoryMap</span><span class="p">(</span><span class="n">addr_width</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">data_width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

<span class="n">reg_ctrl</span> <span class="o">=</span> <span class="n">csr</span><span class="o">.</span><span class="n">Register</span><span class="p">(</span><span class="n">csr</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">csr</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">RW</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="s2">&quot;rw&quot;</span><span class="p">)</span>
<span class="n">reg_data</span> <span class="o">=</span> <span class="n">csr</span><span class="o">.</span><span class="n">Register</span><span class="p">(</span><span class="n">csr</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">csr</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">RW</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="s2">&quot;rw&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">memory_map</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">reg_ctrl</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">addr</span><span class="o">=</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;ctrl&quot;</span><span class="p">,))</span>
<span class="go">(0, 4)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">memory_map</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">reg_data</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">addr</span><span class="o">=</span><span class="mh">0x4</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,))</span>
<span class="go">(4, 8)</span>
</pre></div>
</div>
<div class="admonition note" id="memory-implicit-next-address">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">addr</span></code> parameter of <a class="reference internal" href="#amaranth_soc.memory.MemoryMap.add_resource" title="amaranth_soc.memory.MemoryMap.add_resource"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MemoryMap.add_resource()</span></code></a> and <a class="reference internal" href="#amaranth_soc.memory.MemoryMap.add_window" title="amaranth_soc.memory.MemoryMap.add_window"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MemoryMap.add_window()</span></code></a> is optional.</p>
<p>To simplify address assignment, each <a class="reference internal" href="#amaranth_soc.memory.MemoryMap" title="amaranth_soc.memory.MemoryMap"><code class="xref py py-class docutils literal notranslate"><span class="pre">MemoryMap</span></code></a> has an <em>implicit next address</em>, starting at 0. If a resource or a window is added without an explicit address, the implicit next address is used. In any case, the implicit next address is set to the address immediately following the newly added resource or window.</p>
</div>
</section>
<section id="accessing-resources">
<h3>Accessing resources<a class="headerlink" href="#accessing-resources" title="Link to this heading"></a></h3>
<p>Memory map resources can be iterated with <a class="reference internal" href="#amaranth_soc.memory.MemoryMap.resources" title="amaranth_soc.memory.MemoryMap.resources"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MemoryMap.resources()</span></code></a>:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">resource</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="ow">in</span> <span class="n">memory_map</span><span class="o">.</span><span class="n">resources</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;name=</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">, start=</span><span class="si">{</span><span class="n">start</span><span class="si">:</span><span class="s2">#x</span><span class="si">}</span><span class="s2">, end=</span><span class="si">{</span><span class="n">end</span><span class="si">:</span><span class="s2">#x</span><span class="si">}</span><span class="s2">, resource=</span><span class="si">{</span><span class="n">resource</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">name=Name(&#39;ctrl&#39;), start=0x0, end=0x4, resource=&lt;...&gt;</span>
<span class="go">name=Name(&#39;data&#39;), start=0x4, end=0x8, resource=&lt;...&gt;</span>
</pre></div>
</div>
<p>A memory map can be queried with <a class="reference internal" href="#amaranth_soc.memory.MemoryMap.find_resource" title="amaranth_soc.memory.MemoryMap.find_resource"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MemoryMap.find_resource()</span></code></a> to get the name and address range of a given resource:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">memory_map</span><span class="o">.</span><span class="n">find_resource</span><span class="p">(</span><span class="n">reg_ctrl</span><span class="p">)</span>
<span class="go">ResourceInfo(path=(Name(&#39;ctrl&#39;),), start=0x0, end=0x4, width=8)</span>
</pre></div>
</div>
<p>The resource located at a given address can be retrieved with <a class="reference internal" href="#amaranth_soc.memory.MemoryMap.decode_address" title="amaranth_soc.memory.MemoryMap.decode_address"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MemoryMap.decode_address()</span></code></a>:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">memory_map</span><span class="o">.</span><span class="n">decode_address</span><span class="p">(</span><span class="mh">0x4</span><span class="p">)</span> <span class="ow">is</span> <span class="n">reg_data</span>
<span class="go">True</span>
</pre></div>
</div>
</section>
</section>
<section id="alignment">
<span id="memory-alignment"></span><h2>Alignment<a class="headerlink" href="#alignment" title="Link to this heading"></a></h2>
<p>The value of <code class="xref py py-attr docutils literal notranslate"><span class="pre">MemoryMap.alignment</span></code> constrains the layout of a memory map. If unspecified, it defaults to 0.</p>
<p>Each resource or window added to a memory map is placed at an address that is a multiple of <code class="docutils literal notranslate"><span class="pre">2</span> <span class="pre">**</span> <span class="pre">alignment</span></code>, and its size is rounded up to a multiple of <code class="docutils literal notranslate"><span class="pre">2</span> <span class="pre">**</span> <span class="pre">alignment</span></code>.</p>
<p>For example, the resources of this memory map are 64-bit aligned:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">memory_map</span> <span class="o">=</span> <span class="n">MemoryMap</span><span class="p">(</span><span class="n">addr_width</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">data_width</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">alignment</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="n">reg_foo</span> <span class="o">=</span> <span class="n">csr</span><span class="o">.</span><span class="n">Register</span><span class="p">(</span><span class="n">csr</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">csr</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">RW</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="s2">&quot;rw&quot;</span><span class="p">)</span>
<span class="n">reg_bar</span> <span class="o">=</span> <span class="n">csr</span><span class="o">.</span><span class="n">Register</span><span class="p">(</span><span class="n">csr</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">csr</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">RW</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="s2">&quot;rw&quot;</span><span class="p">)</span>
<span class="n">reg_baz</span> <span class="o">=</span> <span class="n">csr</span><span class="o">.</span><span class="n">Register</span><span class="p">(</span><span class="n">csr</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">csr</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">RW</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="s2">&quot;rw&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">memory_map</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">reg_foo</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">,))</span>
<span class="go">(0, 8)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">memory_map</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">reg_bar</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;bar&quot;</span><span class="p">,),</span> <span class="n">addr</span><span class="o">=</span><span class="mh">0x9</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="c">...</span>
<span class="gr">ValueError</span>: <span class="n">Explicitly specified address 0x9 must be a multiple of 0x8 bytes</span>
</pre></div>
</div>
<p><a class="reference internal" href="#amaranth_soc.memory.MemoryMap.add_resource" title="amaranth_soc.memory.MemoryMap.add_resource"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MemoryMap.add_resource()</span></code></a> takes an optional <code class="docutils literal notranslate"><span class="pre">alignment</span></code> parameter. If a value greater than <code class="xref py py-attr docutils literal notranslate"><span class="pre">MemoryMap.alignment</span></code> is given, it becomes the alignment of this resource:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">memory_map</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">reg_bar</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;bar&quot;</span><span class="p">,),</span> <span class="n">alignment</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="go">(16, 32)</span>
</pre></div>
</div>
<p><a class="reference internal" href="#amaranth_soc.memory.MemoryMap.align_to" title="amaranth_soc.memory.MemoryMap.align_to"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MemoryMap.align_to()</span></code></a> can be used to align the <a class="reference internal" href="#memory-implicit-next-address"><span class="std std-ref">implicit next address</span></a>. Its alignment is modified if a value greater than <code class="xref py py-attr docutils literal notranslate"><span class="pre">MemoryMap.alignment</span></code> is given.</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">memory_map</span><span class="o">.</span><span class="n">align_to</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="go">64</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">memory_map</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">reg_baz</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;baz&quot;</span><span class="p">,))</span>
<span class="go">(64, 72)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#amaranth_soc.memory.MemoryMap.align_to" title="amaranth_soc.memory.MemoryMap.align_to"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MemoryMap.align_to()</span></code></a> has no effect on the size of the next resource or window.</p>
</div>
</section>
<section id="windows">
<span id="memory-windows"></span><h2>Windows<a class="headerlink" href="#windows" title="Link to this heading"></a></h2>
<p>A <em>window</em> is a <a class="reference internal" href="#amaranth_soc.memory.MemoryMap" title="amaranth_soc.memory.MemoryMap"><code class="xref py py-class docutils literal notranslate"><span class="pre">MemoryMap</span></code></a> nested inside another memory map. Each window occupies an unique range of addresses within the memory map, and represents a bridge to a subordinate bus.</p>
<section id="adding-windows">
<h3>Adding windows<a class="headerlink" href="#adding-windows" title="Link to this heading"></a></h3>
<p>Windows are added with <a class="reference internal" href="#amaranth_soc.memory.MemoryMap.add_window" title="amaranth_soc.memory.MemoryMap.add_window"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MemoryMap.add_window()</span></code></a>, which returns a <code class="docutils literal notranslate"><span class="pre">(start,</span> <span class="pre">end,</span> <span class="pre">ratio)</span></code> tuple describing their address range:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">reg_ctrl</span>    <span class="o">=</span> <span class="n">csr</span><span class="o">.</span><span class="n">Register</span><span class="p">(</span><span class="n">csr</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">csr</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">RW</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="s2">&quot;rw&quot;</span><span class="p">)</span>
<span class="n">reg_rx_data</span> <span class="o">=</span> <span class="n">csr</span><span class="o">.</span><span class="n">Register</span><span class="p">(</span><span class="n">csr</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">csr</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">RW</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="s2">&quot;rw&quot;</span><span class="p">)</span>
<span class="n">reg_tx_data</span> <span class="o">=</span> <span class="n">csr</span><span class="o">.</span><span class="n">Register</span><span class="p">(</span><span class="n">csr</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">csr</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">RW</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="s2">&quot;rw&quot;</span><span class="p">)</span>

<span class="n">memory_map</span> <span class="o">=</span> <span class="n">MemoryMap</span><span class="p">(</span><span class="n">addr_width</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">data_width</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
<span class="n">rx_window</span>  <span class="o">=</span> <span class="n">MemoryMap</span><span class="p">(</span><span class="n">addr_width</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">data_width</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
<span class="n">tx_window</span>  <span class="o">=</span> <span class="n">MemoryMap</span><span class="p">(</span><span class="n">addr_width</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">data_width</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">memory_map</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">reg_ctrl</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;ctrl&quot;</span><span class="p">,))</span>
<span class="go">(0, 1)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">rx_window</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">reg_rx_data</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,))</span>
<span class="go">(0, 1)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">memory_map</span><span class="o">.</span><span class="n">add_window</span><span class="p">(</span><span class="n">rx_window</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;rx&quot;</span><span class="p">,))</span>
<span class="go">(4096, 8192, 1)</span>
</pre></div>
</div>
<p>The third value returned by <a class="reference internal" href="#amaranth_soc.memory.MemoryMap.add_window" title="amaranth_soc.memory.MemoryMap.add_window"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MemoryMap.add_window()</span></code></a> represents the number of addresses that are accessed in the bus described by <code class="docutils literal notranslate"><span class="pre">rx_window</span></code> for one transaction in the bus described by <code class="docutils literal notranslate"><span class="pre">memory_map</span></code>. It is 1 in this case, as both busses have the same width.</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">tx_window</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">reg_tx_data</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,))</span>
<span class="go">(0, 1)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">memory_map</span><span class="o">.</span><span class="n">add_window</span><span class="p">(</span><span class="n">tx_window</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;tx&quot;</span><span class="p">,))</span>
<span class="go">(8192, 12288, 1)</span>
</pre></div>
</div>
<section id="accessing-windows">
<span id="memory-accessing-windows"></span><h4>Accessing windows<a class="headerlink" href="#accessing-windows" title="Link to this heading"></a></h4>
<p>Memory map windows can be iterated with <a class="reference internal" href="#amaranth_soc.memory.MemoryMap.windows" title="amaranth_soc.memory.MemoryMap.windows"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MemoryMap.windows()</span></code></a>:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">window</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">ratio</span><span class="p">)</span> <span class="ow">in</span> <span class="n">memory_map</span><span class="o">.</span><span class="n">windows</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">, start=</span><span class="si">{</span><span class="n">start</span><span class="si">:</span><span class="s2">#x</span><span class="si">}</span><span class="s2">, end=</span><span class="si">{</span><span class="n">end</span><span class="si">:</span><span class="s2">#x</span><span class="si">}</span><span class="s2">, ratio=</span><span class="si">{</span><span class="n">ratio</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">Name(&#39;rx&#39;), start=0x1000, end=0x2000, ratio=1</span>
<span class="go">Name(&#39;tx&#39;), start=0x2000, end=0x3000, ratio=1</span>
</pre></div>
</div>
<p>Windows can also be iterated with <a class="reference internal" href="#amaranth_soc.memory.MemoryMap.window_patterns" title="amaranth_soc.memory.MemoryMap.window_patterns"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MemoryMap.window_patterns()</span></code></a>, which encodes their address ranges as bit patterns compatible with the <a class="reference internal" href="../amaranth/guide.html#lang-matchop"><span class="std std-ref">match operator</span></a> and the <a class="reference internal" href="../amaranth/guide.html#lang-switch"><span class="std std-ref">Case block</span></a>:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">window</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">ratio</span><span class="p">)</span> <span class="ow">in</span> <span class="n">memory_map</span><span class="o">.</span><span class="n">window_patterns</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">, pattern=&#39;</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&#39;, ratio=</span><span class="si">{</span><span class="n">ratio</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">Name(&#39;rx&#39;), pattern=&#39;01------------&#39;, ratio=1</span>
<span class="go">Name(&#39;tx&#39;), pattern=&#39;10------------&#39;, ratio=1</span>
</pre></div>
</div>
<p>Memory map resources can be recursively iterated with <a class="reference internal" href="#amaranth_soc.memory.MemoryMap.all_resources" title="amaranth_soc.memory.MemoryMap.all_resources"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MemoryMap.all_resources()</span></code></a>, which yields instances of <a class="reference internal" href="#amaranth_soc.memory.ResourceInfo" title="amaranth_soc.memory.ResourceInfo"><code class="xref py py-class docutils literal notranslate"><span class="pre">ResourceInfo</span></code></a>:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">res_info</span> <span class="ow">in</span> <span class="n">memory_map</span><span class="o">.</span><span class="n">all_resources</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">res_info</span><span class="p">)</span>
<span class="go">ResourceInfo(path=(Name(&#39;ctrl&#39;),), start=0x0, end=0x1, width=32)</span>
<span class="go">ResourceInfo(path=(Name(&#39;rx&#39;), Name(&#39;data&#39;)), start=0x1000, end=0x1001, width=32)</span>
<span class="go">ResourceInfo(path=(Name(&#39;tx&#39;), Name(&#39;data&#39;)), start=0x2000, end=0x2001, width=32)</span>
</pre></div>
</div>
</section>
</section>
<section id="address-translation">
<h3>Address translation<a class="headerlink" href="#address-translation" title="Link to this heading"></a></h3>
<p>When a memory map resource is accessed through a window, address translation may happen in three different modes.</p>
<section id="transparent-mode">
<h4>Transparent mode<a class="headerlink" href="#transparent-mode" title="Link to this heading"></a></h4>
<p>In <em>transparent mode</em>, each transaction on the primary bus results in one transaction on the subordinate bus without loss of data. This mode is selected when <a class="reference internal" href="#amaranth_soc.memory.MemoryMap.add_window" title="amaranth_soc.memory.MemoryMap.add_window"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MemoryMap.add_window()</span></code></a> is given <code class="docutils literal notranslate"><span class="pre">sparse=None</span></code>, which will fail if the window and the memory map have a different data widths.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In practice, transparent mode is identical to other modes; it can only be used with equal data widths, which results in the same behavior regardless of the translation mode. However, it causes <a class="reference internal" href="#amaranth_soc.memory.MemoryMap.add_window" title="amaranth_soc.memory.MemoryMap.add_window"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MemoryMap.add_window()</span></code></a> to fail if the data widths are different.</p>
</div>
</section>
<section id="sparse-mode">
<h4>Sparse mode<a class="headerlink" href="#sparse-mode" title="Link to this heading"></a></h4>
<p>In <em>sparse mode</em>, each transaction on the wide primary bus results in one transaction on the narrow subordinate bus. High data bits on the primary bus are ignored, and any contiguous resource on the subordinate bus becomes discontiguous on the primary bus. This mode is selected when <a class="reference internal" href="#amaranth_soc.memory.MemoryMap.add_window" title="amaranth_soc.memory.MemoryMap.add_window"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MemoryMap.add_window()</span></code></a> is given <code class="docutils literal notranslate"><span class="pre">sparse=True</span></code>.</p>
</section>
<section id="dense-mode">
<h4>Dense mode<a class="headerlink" href="#dense-mode" title="Link to this heading"></a></h4>
<p>In <em>dense mode</em>, each transaction on the wide primary bus results in several transactions on the narrow subordinate bus, and any contiguous resource on the subordinate bus stays contiguous on the primary bus. This mode is selected when <a class="reference internal" href="#amaranth_soc.memory.MemoryMap.add_window" title="amaranth_soc.memory.MemoryMap.add_window"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MemoryMap.add_window()</span></code></a> is given <code class="docutils literal notranslate"><span class="pre">sparse=False</span></code>.</p>
</section>
</section>
</section>
<section id="freezing">
<h2>Freezing<a class="headerlink" href="#freezing" title="Link to this heading"></a></h2>
<p>The state of a memory map can become immutable by calling <a class="reference internal" href="#amaranth_soc.memory.MemoryMap.freeze" title="amaranth_soc.memory.MemoryMap.freeze"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MemoryMap.freeze()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">memory_map</span> <span class="o">=</span> <span class="n">MemoryMap</span><span class="p">(</span><span class="n">addr_width</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">data_width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

<span class="n">reg_ctrl</span> <span class="o">=</span> <span class="n">csr</span><span class="o">.</span><span class="n">Register</span><span class="p">(</span><span class="n">csr</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">csr</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">RW</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="s2">&quot;rw&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">memory_map</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">memory_map</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">reg_ctrl</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">addr</span><span class="o">=</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;ctrl&quot;</span><span class="p">,))</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="c">...</span>
<span class="gr">ValueError</span>: <span class="n">Memory map has been frozen. Cannot add resource &lt;...&gt;</span>
</pre></div>
</div>
<p>It is recommended to freeze a memory map before passing it to external logic, as a preventive measure against TOCTTOU bugs.</p>
<dl class="py class">
<dt class="sig sig-object py" id="amaranth_soc.memory.MemoryMap">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">amaranth_soc.memory.</span></span><span class="sig-name descname"><span class="pre">MemoryMap</span></span><a class="headerlink" href="#amaranth_soc.memory.MemoryMap" title="Link to this definition"></a></dt>
<dd><dl class="py method">
<dt class="sig sig-object py" id="amaranth_soc.memory.MemoryMap.freeze">
<span class="sig-name descname"><span class="pre">freeze</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#amaranth_soc.memory.MemoryMap.freeze" title="Link to this definition"></a></dt>
<dd><p>Freeze the <a class="reference internal" href="#amaranth_soc.memory.MemoryMap" title="amaranth_soc.memory.MemoryMap"><code class="xref py py-class docutils literal notranslate"><span class="pre">MemoryMap</span></code></a>.</p>
<p>Once the <a class="reference internal" href="#amaranth_soc.memory.MemoryMap" title="amaranth_soc.memory.MemoryMap"><code class="xref py py-class docutils literal notranslate"><span class="pre">MemoryMap</span></code></a> is frozen, its visible state becomes immutable. Resources and
windows cannot be added anymore.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="amaranth_soc.memory.MemoryMap.align_to">
<span class="sig-name descname"><span class="pre">align_to</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">alignment</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#amaranth_soc.memory.MemoryMap.align_to" title="Link to this definition"></a></dt>
<dd><p>Align the <a class="reference internal" href="#memory-implicit-next-address"><span class="std std-ref">implicit next address</span></a>.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>alignment</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a>, power-of-2 exponent) – Address alignment. The start of the implicit next address will be a multiple of
<code class="docutils literal notranslate"><span class="pre">2</span> <span class="pre">**</span> <span class="pre">max(alignment,</span> <span class="pre">self.alignment)</span></code>.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>Implicit next address.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a></p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="amaranth_soc.memory.MemoryMap.add_resource">
<span class="sig-name descname"><span class="pre">add_resource</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">resource</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">size</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">addr</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">alignment</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#amaranth_soc.memory.MemoryMap.add_resource" title="Link to this definition"></a></dt>
<dd><p>Add a resource.</p>
<p>A resource is any device on the bus that is a destination for bus transactions, e.g.
a register or a memory block.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>resource</strong> (<a class="reference internal" href="../amaranth/stdlib/wiring.html#amaranth.lib.wiring.Component" title="amaranth.lib.wiring.Component"><code class="xref py py-class docutils literal notranslate"><span class="pre">amaranth.lib.wiring.Component</span></code></a>) – The resource to be added.</p></li>
<li><p><strong>name</strong> (<code class="xref py py-class docutils literal notranslate"><span class="pre">MemoryMap.Name</span></code>) – Name of the resource. It must not conflict with the name of other resources or windows
present in this memory map.</p></li>
<li><p><strong>addr</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a>) – Address of the resource. Optional. If <code class="docutils literal notranslate"><span class="pre">None</span></code>, the <a class="reference internal" href="#memory-implicit-next-address"><span class="std std-ref">implicit next address</span></a> will be used. Otherwise, the exact specified address
(which must be a multiple of <code class="docutils literal notranslate"><span class="pre">2</span> <span class="pre">**</span> <span class="pre">max(alignment,</span> <span class="pre">self.alignment)</span></code>) will be used.</p></li>
<li><p><strong>size</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a>) – Size of the resource, in minimal addressable units. Rounded up to a multiple of
<code class="docutils literal notranslate"><span class="pre">2</span> <span class="pre">**</span> <span class="pre">max(alignment,</span> <span class="pre">self.alignment)</span></code>.</p></li>
<li><p><strong>alignment</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a>, power-of-2 exponent) – Alignment of the resource. Optional. If <code class="docutils literal notranslate"><span class="pre">None</span></code>, the memory map alignment is used.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>A tuple <code class="docutils literal notranslate"><span class="pre">(start,</span> <span class="pre">end)</span></code> describing the address range assigned to the resource.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#tuple" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">tuple</span></code></a> of (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a>, <a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a>)</p>
</dd>
<dt class="field-even">Raises<span class="colon">:</span></dt>
<dd class="field-even"><ul class="simple">
<li><p><a class="reference external" href="https://docs.python.org/3/library/exceptions.html#ValueError" title="(in Python v3.13)"><strong>ValueError</strong></a> – If the memory map is frozen.</p></li>
<li><p><a class="reference external" href="https://docs.python.org/3/library/exceptions.html#ValueError" title="(in Python v3.13)"><strong>ValueError</strong></a> – If the requested address and size, after alignment, would overlap with any resources or
    windows that have already been added, or would be out of bounds.</p></li>
<li><p><a class="reference external" href="https://docs.python.org/3/library/exceptions.html#ValueError" title="(in Python v3.13)"><strong>ValueError</strong></a> – If <code class="docutils literal notranslate"><span class="pre">resource</span></code> has already been added to this memory map.</p></li>
<li><p><a class="reference external" href="https://docs.python.org/3/library/exceptions.html#ValueError" title="(in Python v3.13)"><strong>ValueError</strong></a> – If the requested name would conflict with the name of other resources or windows that
    have already been added.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="amaranth_soc.memory.MemoryMap.resources">
<span class="sig-name descname"><span class="pre">resources</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#amaranth_soc.memory.MemoryMap.resources" title="Link to this definition"></a></dt>
<dd><p>Iterate local resources and their address ranges.</p>
<p>Non-recursively iterate resources in ascending order of their address.</p>
<dl class="field-list simple">
<dt class="field-odd">Yields<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#tuple" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">tuple</span></code></a> of (<a class="reference internal" href="../amaranth/stdlib/wiring.html#amaranth.lib.wiring.Component" title="amaranth.lib.wiring.Component"><code class="xref py py-class docutils literal notranslate"><span class="pre">amaranth.lib.wiring.Component</span></code></a>, <code class="xref py py-class docutils literal notranslate"><span class="pre">MemoryMap.Name</span></code>,         <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#tuple" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">tuple</span></code></a> of (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a>, <a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a>)) – A tuple <code class="docutils literal notranslate"><span class="pre">resource,</span> <span class="pre">name,</span> <span class="pre">(start,</span> <span class="pre">end)</span></code> describing the address range assigned to the
resource.</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="amaranth_soc.memory.MemoryMap.add_window">
<span class="sig-name descname"><span class="pre">add_window</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">window</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">name</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">addr</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">sparse</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#amaranth_soc.memory.MemoryMap.add_window" title="Link to this definition"></a></dt>
<dd><p>Add a window.</p>
<p>A window is a device on a bus that provides access to a different bus, i.e. a bus bridge.
It performs address translation, such that the devices on a subordinate bus have different
addresses; the memory map reflects this address translation when resources are looked up
through the window.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>window</strong> (<a class="reference internal" href="#amaranth_soc.memory.MemoryMap" title="amaranth_soc.memory.MemoryMap"><code class="xref py py-class docutils literal notranslate"><span class="pre">MemoryMap</span></code></a>) – A <a class="reference internal" href="#amaranth_soc.memory.MemoryMap" title="amaranth_soc.memory.MemoryMap"><code class="xref py py-class docutils literal notranslate"><span class="pre">MemoryMap</span></code></a> describing the layout of the window. It is frozen as a side-effect
of being added to this memory map.</p></li>
<li><p><strong>name</strong> (<code class="xref py py-class docutils literal notranslate"><span class="pre">MemoryMap.Name</span></code>) – Name of the window. Optional. It must not conflict with the name of other resources or
windows present in this memory map.</p></li>
<li><p><strong>addr</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a>) – Address of the window. Optional. If <code class="docutils literal notranslate"><span class="pre">None</span></code>, the <a class="reference internal" href="#memory-implicit-next-address"><span class="std std-ref">implicit next address</span></a> will be used after aligning it to
<code class="docutils literal notranslate"><span class="pre">2</span> <span class="pre">**</span> <span class="pre">window.addr_width</span></code>. Otherwise, the exact specified address (which must be a
multiple of <code class="docutils literal notranslate"><span class="pre">2</span> <span class="pre">**</span> <span class="pre">window.addr_width</span></code>) will be used.</p></li>
<li><p><strong>sparse</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">bool</span></code></a>) – Address translation type. Optional. Ignored if the datapath widths of both memory maps
are equal; must be specified otherwise.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>A tuple <code class="docutils literal notranslate"><span class="pre">(start,</span> <span class="pre">end,</span> <span class="pre">ratio)</span></code> describing the address range assigned to the window.
When bridging buses of unequal data width, <code class="docutils literal notranslate"><span class="pre">ratio</span></code> is the amount of contiguous
addresses on the narrower bus that are accessed for each transaction on the wider bus.
Otherwise, it is always 1.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#tuple" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">tuple</span></code></a> of (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a>, <a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a>, <a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a>)</p>
</dd>
<dt class="field-even">Raises<span class="colon">:</span></dt>
<dd class="field-even"><ul class="simple">
<li><p><a class="reference external" href="https://docs.python.org/3/library/exceptions.html#ValueError" title="(in Python v3.13)"><strong>ValueError</strong></a> – If the memory map is frozen.</p></li>
<li><p><a class="reference external" href="https://docs.python.org/3/library/exceptions.html#ValueError" title="(in Python v3.13)"><strong>ValueError</strong></a> – If the requested address and size, after alignment, would overlap with any resources or
    windows that have already been added, or would be out of bounds.</p></li>
<li><p><a class="reference external" href="https://docs.python.org/3/library/exceptions.html#ValueError" title="(in Python v3.13)"><strong>ValueError</strong></a> – If <code class="docutils literal notranslate"><span class="pre">window.data_width</span></code> is wider than <code class="xref py py-attr docutils literal notranslate"><span class="pre">data_width</span></code>.</p></li>
<li><p><a class="reference external" href="https://docs.python.org/3/library/exceptions.html#ValueError" title="(in Python v3.13)"><strong>ValueError</strong></a> – If the address translation mode is unspecified and <code class="docutils literal notranslate"><span class="pre">window.data_width</span></code> is different
    than <code class="xref py py-attr docutils literal notranslate"><span class="pre">data_width</span></code>.</p></li>
<li><p><a class="reference external" href="https://docs.python.org/3/library/exceptions.html#ValueError" title="(in Python v3.13)"><strong>ValueError</strong></a> – If dense address translation is used and <code class="xref py py-attr docutils literal notranslate"><span class="pre">data_width</span></code> is not an integer multiple
    of <code class="docutils literal notranslate"><span class="pre">window.data_width</span></code>.</p></li>
<li><p><a class="reference external" href="https://docs.python.org/3/library/exceptions.html#ValueError" title="(in Python v3.13)"><strong>ValueError</strong></a> – If dense address translation is used and the ratio of <code class="xref py py-attr docutils literal notranslate"><span class="pre">data_width</span></code> to
    <code class="docutils literal notranslate"><span class="pre">window.data_width</span></code> is not a power of 2.</p></li>
<li><p><a class="reference external" href="https://docs.python.org/3/library/exceptions.html#ValueError" title="(in Python v3.13)"><strong>ValueError</strong></a> – If dense address translation is used and the ratio of <code class="xref py py-attr docutils literal notranslate"><span class="pre">data_width</span></code> to
    <code class="docutils literal notranslate"><span class="pre">window.data_width</span></code> is lesser than 2 raised to the power of <code class="xref py py-attr docutils literal notranslate"><span class="pre">alignment</span></code>.</p></li>
<li><p><a class="reference external" href="https://docs.python.org/3/library/exceptions.html#ValueError" title="(in Python v3.13)"><strong>ValueError</strong></a> – If the requested name would conflict with the name of other resources or windows that
    have already been added.</p></li>
<li><p><a class="reference external" href="https://docs.python.org/3/library/exceptions.html#ValueError" title="(in Python v3.13)"><strong>ValueError</strong></a> – If <code class="docutils literal notranslate"><span class="pre">window</span></code> is anonymous and the name of one of its resources or windows would
    conflict with the name of any resources or windows that have already been added.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="amaranth_soc.memory.MemoryMap.windows">
<span class="sig-name descname"><span class="pre">windows</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#amaranth_soc.memory.MemoryMap.windows" title="Link to this definition"></a></dt>
<dd><p>Iterate local windows and their address ranges.</p>
<p>Non-recursively iterate windows in ascending order of their address.</p>
<dl class="field-list simple">
<dt class="field-odd">Yields<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#tuple" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">tuple</span></code></a> of (<a class="reference internal" href="#amaranth_soc.memory.MemoryMap" title="amaranth_soc.memory.MemoryMap"><code class="xref py py-class docutils literal notranslate"><span class="pre">MemoryMap</span></code></a>, <code class="xref py py-class docutils literal notranslate"><span class="pre">MemoryMap.Name</span></code>, <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#tuple" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">tuple</span></code></a> of         (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a>, <a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a>, <a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a>)) – A tuple <code class="docutils literal notranslate"><span class="pre">window,</span> <span class="pre">name,</span> <span class="pre">(start,</span> <span class="pre">end,</span> <span class="pre">ratio)</span></code> describing the address range assigned to
the window. When bridging busses of unequal data widths, <code class="docutils literal notranslate"><span class="pre">ratio</span></code> is the amount of
contiguous addresses on the narrower bus that are accessed for each transaction on the
wider bus. Otherwise, it is always 1.</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="amaranth_soc.memory.MemoryMap.window_patterns">
<span class="sig-name descname"><span class="pre">window_patterns</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#amaranth_soc.memory.MemoryMap.window_patterns" title="Link to this definition"></a></dt>
<dd><p>Iterate local windows and patterns that match their address ranges.</p>
<p>Non-recursively iterate windows in ascending order of their address.</p>
<dl class="field-list simple">
<dt class="field-odd">Yields<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#tuple" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">tuple</span></code></a> of (<a class="reference internal" href="#amaranth_soc.memory.MemoryMap" title="amaranth_soc.memory.MemoryMap"><code class="xref py py-class docutils literal notranslate"><span class="pre">MemoryMap</span></code></a>, <code class="xref py py-class docutils literal notranslate"><span class="pre">MemoryMap.Name</span></code>, <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#tuple" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">tuple</span></code></a> of         (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">str</span></code></a>, <a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a>)) – A tuple <code class="docutils literal notranslate"><span class="pre">window,</span> <span class="pre">name,</span> <span class="pre">(pattern,</span> <span class="pre">ratio)</span></code> describing the address range assigned to the
window. <code class="docutils literal notranslate"><span class="pre">pattern</span></code> is a <code class="xref py py-attr docutils literal notranslate"><span class="pre">addr_width</span></code> wide pattern that may be used in <code class="docutils literal notranslate"><span class="pre">Case</span></code>
or <code class="docutils literal notranslate"><span class="pre">match</span></code> to determine if a value is within the address range of <code class="docutils literal notranslate"><span class="pre">window</span></code>. When
bridging busses of unequal data widths, <code class="docutils literal notranslate"><span class="pre">ratio</span></code> is the amount of contiguous addresses
on the narrower bus that are accessed for each transaction on the wider bus. Otherwise,
it is always 1.</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="amaranth_soc.memory.MemoryMap.all_resources">
<span class="sig-name descname"><span class="pre">all_resources</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#amaranth_soc.memory.MemoryMap.all_resources" title="Link to this definition"></a></dt>
<dd><p>Iterate all resources and their address ranges.</p>
<p>Recursively iterate all resources in ascending order of their address, performing address
translation for resources that are located behind a window.</p>
<dl class="field-list simple">
<dt class="field-odd">Yields<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference internal" href="#amaranth_soc.memory.ResourceInfo" title="amaranth_soc.memory.ResourceInfo"><code class="xref py py-class docutils literal notranslate"><span class="pre">ResourceInfo</span></code></a> – A description of the resource and its address range.</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="amaranth_soc.memory.MemoryMap.find_resource">
<span class="sig-name descname"><span class="pre">find_resource</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">resource</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#amaranth_soc.memory.MemoryMap.find_resource" title="Link to this definition"></a></dt>
<dd><p>Find address range corresponding to a resource.</p>
<p>Recursively find the address range of a resource, performing address translation for
resources that are located behind a window.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>resource</strong> (<a class="reference internal" href="../amaranth/stdlib/wiring.html#amaranth.lib.wiring.Component" title="amaranth.lib.wiring.Component"><code class="xref py py-class docutils literal notranslate"><span class="pre">amaranth.lib.wiring.Component</span></code></a>) – Resource previously added to this <a class="reference internal" href="#amaranth_soc.memory.MemoryMap" title="amaranth_soc.memory.MemoryMap"><code class="xref py py-class docutils literal notranslate"><span class="pre">MemoryMap</span></code></a> or one of its windows.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>A description of the resource and its address range.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference internal" href="#amaranth_soc.memory.ResourceInfo" title="amaranth_soc.memory.ResourceInfo"><code class="xref py py-class docutils literal notranslate"><span class="pre">ResourceInfo</span></code></a></p>
</dd>
<dt class="field-even">Raises<span class="colon">:</span></dt>
<dd class="field-even"><p><a class="reference external" href="https://docs.python.org/3/library/exceptions.html#KeyError" title="(in Python v3.13)"><strong>KeyError</strong></a> – If the resource is not found.</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="amaranth_soc.memory.MemoryMap.decode_address">
<span class="sig-name descname"><span class="pre">decode_address</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">address</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#amaranth_soc.memory.MemoryMap.decode_address" title="Link to this definition"></a></dt>
<dd><p>Decode an address to a resource.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>address</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a>) – Address of interest.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>A resource mapped to the provided address, or <code class="docutils literal notranslate"><span class="pre">None</span></code> if there is no such resource.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference internal" href="../amaranth/stdlib/wiring.html#amaranth.lib.wiring.Component" title="amaranth.lib.wiring.Component"><code class="xref py py-class docutils literal notranslate"><span class="pre">amaranth.lib.wiring.Component</span></code></a> or <code class="docutils literal notranslate"><span class="pre">None</span></code></p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="amaranth_soc.memory.ResourceInfo">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">amaranth_soc.memory.</span></span><span class="sig-name descname"><span class="pre">ResourceInfo</span></span><a class="headerlink" href="#amaranth_soc.memory.ResourceInfo" title="Link to this definition"></a></dt>
<dd><p>Resource metadata.</p>
<p>A description of a <a class="reference internal" href="#amaranth_soc.memory.MemoryMap" title="amaranth_soc.memory.MemoryMap"><code class="xref py py-class docutils literal notranslate"><span class="pre">MemoryMap</span></code></a> resource with its assigned path and address range.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>resource</strong> (<a class="reference internal" href="../amaranth/stdlib/wiring.html#amaranth.lib.wiring.Component" title="amaranth.lib.wiring.Component"><code class="xref py py-class docutils literal notranslate"><span class="pre">amaranth.lib.wiring.Component</span></code></a>) – A resource located in the <a class="reference internal" href="#amaranth_soc.memory.MemoryMap" title="amaranth_soc.memory.MemoryMap"><code class="xref py py-class docutils literal notranslate"><span class="pre">MemoryMap</span></code></a>. See <a class="reference internal" href="#amaranth_soc.memory.MemoryMap.add_resource" title="amaranth_soc.memory.MemoryMap.add_resource"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MemoryMap.add_resource()</span></code></a> for
details.</p></li>
<li><p><strong>path</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#tuple" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">tuple</span></code></a> of <code class="xref py py-class docutils literal notranslate"><span class="pre">MemoryMap.Name</span></code>) – Path of the resource. It is composed of the names of each window sitting between
the resource and the <a class="reference internal" href="#amaranth_soc.memory.MemoryMap" title="amaranth_soc.memory.MemoryMap"><code class="xref py py-class docutils literal notranslate"><span class="pre">MemoryMap</span></code></a> from which this <a class="reference internal" href="#amaranth_soc.memory.ResourceInfo" title="amaranth_soc.memory.ResourceInfo"><code class="xref py py-class docutils literal notranslate"><span class="pre">ResourceInfo</span></code></a> was obtained.
See <a class="reference internal" href="#amaranth_soc.memory.MemoryMap.add_window" title="amaranth_soc.memory.MemoryMap.add_window"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MemoryMap.add_window()</span></code></a> for details.</p></li>
<li><p><strong>start</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a>) – Start of the address range assigned to the resource.</p></li>
<li><p><strong>end</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a>) – End of the address range assigned to the resource.</p></li>
<li><p><strong>width</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a>) – Amount of data bits accessed at each address. It may be equal to the data width of the
<a class="reference internal" href="#amaranth_soc.memory.MemoryMap" title="amaranth_soc.memory.MemoryMap"><code class="xref py py-class docutils literal notranslate"><span class="pre">MemoryMap</span></code></a> from which this <a class="reference internal" href="#amaranth_soc.memory.ResourceInfo" title="amaranth_soc.memory.ResourceInfo"><code class="xref py py-class docutils literal notranslate"><span class="pre">ResourceInfo</span></code></a> was obtained, or less if the
resource is located behind a window that uses sparse addressing.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../amaranth-soc.html" class="btn btn-neutral float-left" title="Amaranth System on Chip toolkit" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="wishbone.html" class="btn btn-neutral float-right" title="Wishbone" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, ChipFlow.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>